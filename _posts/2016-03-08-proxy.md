---
layout: post
title: Proxy
---

1. Real proxy

   >ss (Shadowsocks), Tor, VPN, GAE etc.

   Real proxy listens on a specific *[IP]:port* for incoming request.
2. Torify/Torsocks - Direct traffic **at shell level**!

   >A tool associated with Tor.

   Run in terminal (virtual) to direct all traffic of the application through really proxy - Tor.

   *Above* application layer.
2. Assistant proxy - Direct traffic **at application layer**!

   >Privoxy, Foxproxy, Autoproxy etc.

   Assistant proxy only forwards application's traffic reqeust to real proxy. Defines which traffic uses proxy and which traffic does not. For example, Foxproxy can add a PAC list forwarding traffic to real proxy.

   Control achieved through *application layer protocol*.

   Privoxy is a non-caching web proxy with advanced filtering capabilities for enhancing privacy, modifying web page data and HTTP headers, controlling access, and removing ads and other obnoxious Internet junk. Privoxy has a flexible configuration and can be customized to suit individual needs and tastes. It has application for both stand-alone systems and multi-user networks:

   1. Do NOT provide proxy functionality itself but forward HTTP traffic to other proxies, i.e. Tor, Shadowsocks, GAE etc.
   2. Only for applications that support HTTP proxy, i.e. browser, instant messager etc.

3. Iptables - Direct traffic **at TCP/IP layer**!
4. These three levels traffic control can be combined to suit our needs.
5. SS alone as a SOCKS proxy. Add SS to Tor as a *front end* proxy if no *Bridges* are available.

   Both are SOCKS proxy. Only applications that support SOCKS proxy can make use of them.

   Browser is such an example.
6. Torify/Torsocks forces traffic through SOCKS proxy if application does not support proxy at all, let alone those not supporting SOCKS proxy.
7. Assistant proxy directs traffic based on application layer protocol.

   Foxproxy and Autoproxy are browser extensions while Privoxy is stand alone application. Therefore Privoxy can serve all applications (besides browser) that support HTTP proxy. Details on how to use Privoxy, refer to the 1st reference. For example, by Privoxy, we can direct *youtube.com* traffic to GAE, while *sex.com* traffic to Tor.

   Currently on my system, no other applications (except browser) that support HTTP proxy needs proxy help. So currently don't install Privoxy. For Firfox, Foxproxy has *whitelist* and *blacklist* applied to proxy. Turn on *Use proxies based on their pre-defined patterns and priorities*.

   Of course, if Privoxy is used, just add a new HTTP proxy entry (Privoxy default 127.0.0.1:8118) to Foxproxy.
8. Iptables direct traffic at TCP/IP layer.

   Each Iptables rule is strict (specific TCP/IP values) but has wide match (many applications). An exetreme example, is forceing all system traffic to Tor/SS.

   One utility is Transparent proxy. At TCP/IP level, REDIRECT all system traffic to Tor, thus avoiding other supporting tools (Torify, Assistant proxy etc.). Additionally, we can place some traffic rule ahead of the Transparent proxy rule to not use Tor - achieving whitelist.

   Details refer to newest Iptables rule.
9. One special case:

   In Foxproxy, select to use Shadowsocks for all URLs. In Iptables, enable Transparent proxy! The actual traffic path:

   1. Foxproxy modify HTTP packet to enclosed in Shadowsocks SOCKS packet;
   2. Iptables Transparent proxy. To establish Tor circuit;
   3. Shadowsocks front end proxy - Tor entry node - Tor middle nodes - Tor exit node;
   4. Shadowsocks SOCKS packet - target URL.

   So Shadowsocks is access twice in the traffic path. And target website actually sees Shadowsocks accessing its service. To avoid this, add a Iptables rule:

   `-A OUTPUT -d ss-ip -p tcp -m tcp --dport ss-port -j RETURN`
9. If network connection fails, check:

   >Real proxy, Torify/Torsocks, Assistant proxy, Iptables etc.
10. Refs:
    1. [如何用 Privoxy](https://program-think.blogspot.com/2014/12/gfw-privoxy.html)
