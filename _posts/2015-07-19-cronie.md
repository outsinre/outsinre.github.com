---
layout: post
title: Cronie and Anacron
---
`cron` automates taks sheduling at specific time. There are many different implementations of which I choose `cronie` with `anacron` USE flag enabled.

1. Idea:
    1. `cron` is basically for servers that won't shutdown. Sheduled tasks of `cron` would **NOT** be executed if the machine is powered off at the exact sheduled time. `anacron` however, does not assume that the machine is running continuously. Hence, it can be used to control regular jobs as daily, weekly, and monthly jobs. `anacron` will check whether scheduled jobs needs executed after it is started.
    2. `cronie` takes care of `/etc/cron.hourly` scripts while `anacron` takes care of `/etc/cron.daily`, `/etc/cron.weekly` and `/etc/cron.monthly` scripts.
    3. `cronie` is responsible for triggering `anacron` by `/etc/cron.hourly/0anacron` script. At the end of this script, you can find `anacron -s` command.
    4. `cronie` makes use of `/etc/crontab` and `/etc/cron.d/` config files, while `anacron` makes use of `/etc/anacrontab`. Sheduled jobs can be added to these config files directly. A better solution is to put your job scripts into corresponding *hourly*, *daily*, *weekly* and *monthly* directeries.
2. \# ect /etc/portage/package.use/cronie

    >sys-process/cronie anacron
3. \# emerge --ask sys-process/cronie
4. \# rc-update add cronie default
    1. Though `anacron` USE flag is added, `anacron` won't run without further configuration - a big bug!. Basically, `anacron` has to be started as a normal hourly `cronie` job.
    2. When `anacron` is installed, it should take over the process of running the `/etc/cron.daily/`, `/etc/cron.weekly/`, and `/etc/cron.monthly/` scripts as documented in the package crontab file (`/etc/crontab`) which is specifically prefixing the daily, weekly and monthly commands with this:

        >[ ! -x /etc/cron.hourly/0anacron ].
    3. **Attention**: `anacron` does **NOT** take care of `/etc/cron.hourly/` scripts which is the main `cronie`'s responsibility. Of the scripts, one is `0anacron` deciding whether `anacron` was run already today. If not, trigger `anacron -s` command with configuration file `/etc/anacrontab`.
    4. `man test` shows `-x FILE`: `FILE` exists and execute (or search) permission is granted. That prefix means if `0anacron` does not exist or is not executable, then `cronie` itself will take care of those daily, weekly and monthly scripts.
    5. In current installation, `[ ! -x /etc/cron.hourly/0anacron ]` actually return `false` (as `1`). So the 4 lines in `/etc/crontab`:

        ```
        59  *  * * *	root	[ ! -x /etc/cron.hourly/0anacron ] && rm -f /var/spool/cron/lastrun/cron.hourly
        9   3  * * *	root	[ ! -x /etc/cron.hourly/0anacron ] && rm -f /var/spool/cron/lastrun/cron.daily
        19  4  * * 6	root	[ ! -x /etc/cron.hourly/0anacron ] && rm -f /var/spool/cron/lastrun/cron.weekly
        29  5  1 * *	root	[ ! -x /etc/cron.hourly/0anacron ] && rm -f /var/spool/cron/lastrun/cron.monthly
        */10  *  * * *	root	[ ! -x /etc/cron.hourly/0anacron ] && { test -x /usr/sbin/run-crons && /usr/sbin/run-crons ; }
        ```
    6. Up to now, you will the current installation **DOES NOT** work at all since `cronie` does not activate `anacron` correctly.
5. Make `cronie` and `anacron` work together smoothly.

    Of course, if you are maintaining a Gentoo server, there is no need to turn on `anacron` USE flag. Then every thing works smoothly - just put your scripts in those script directories.
    
    As we can find the key issue is `cronie` failed to trigger `anacron`. So we just need make sure `anacron` is triggered as an hourly `cronie` job. There are two ways to achieve this.
    1. Add a `cronie` pattern:

        >01 * * * * root run-parts /etc/cron.hourly

        to `cronie`'s config file `/etc/crontab` or `/etc/cron.d/0hourly`.
    2. Remove `[ ! -x /etc/cron.hourly/0anacron ]` from the two lines in `/etc/crontab`:

        ```
        59  *  * * *	root	[ ! -x /etc/cron.hourly/0anacron ] && rm -f /var/spool/cron/lastrun/cron.hourly
        */10  *  * * *	root	[ ! -x /etc/cron.hourly/0anacron ] && { test -x /usr/sbin/run-crons && /usr/sbin/run-crons ; }
        ```
	and get:

        ```
        59  *  * * *	root	rm -f /var/spool/cron/lastrun/cron.hourly
        */10  *  * * *	root	{ test -x /usr/sbin/run-crons && /usr/sbin/run-crons ; }
        ```
    3. I think the second method is better. The first method only guarantee `anacron` triggers successfully, while the 2nd makes sure other hourly scripts under `/etc/cron.hourly/` executed as well.
5. \# ect /etc/cron.weekly/eclean-dist

    >/usr/bin/eclean-dist -d -f -t1h
    1. If no `emerge` instances are running, you can execute command:
        >\# rm -rf /var/tmp/portage

        This directory is the temporary place for emerge to compile pakcages. Upon completioin, `emerge` will remove all those temporary files. However, if emerge aborted abnormaly, those files are left there. We can manually remove them to free more disk space. 
6. \# ect /etc/cron.daily/eix-sync

    >/usr/bin/eix-sync
6. Some special notes:

    All the configuration above are for system-wide jobs/scripts. For a user's specific jobs, the basic tool for `cron` is `crontab -e` command. It edits (or creates one if not exist) file `/var/spool/cron/conrtabs/${USER}`. File name is the same as user account name. Please do **NOT** edit this file manually. Tasks sheduled there are user-specific tasks. For system tasks, edit file in `/etc/crontab`, `/etc/cron.d/`, and/or hourly, daily, weekly and monthly scripts manully.

    From above configuration, we see that jobs can be put in both config file like `/etc/crontab` and script directories like `/etc/cron.hourly`. The basic difference is that jobs in config file is usually a simple command, while those in scripts are capable of complicated tasks.
8. References:
    1. [arch wiki cron](https://wiki.archlinux.org/index.php/Cron#Cronie)
    2. [gentoo wiki cron](https://wiki.gentoo.org/wiki/Cron)
    3. [bug 538864](https://bugs.gentoo.org/show_bug.cgi?id=538864)
    4. [how cronie anacron hourly daily weekly work](http://www.nico.schottelius.org/blog/how-cronie-anacron-cron-hourly-daily-weekly-work/)
    5. [Cronie changes](https://bbs.archlinux.org/viewtopic.php?id=118104)
    