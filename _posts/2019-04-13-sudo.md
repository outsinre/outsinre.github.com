---
layout: post
title: sudo
---

1. toc
{:toc}

# sudo Front End #

*sudo* allows a permitted user to execute a command as the superuser (by default) or another user (if provided), as specified by a *security policy*.

*sudo* is just a front end and depends on a *plugin architecture* to load different security policies. We can configure a plugin in */etc/sudo.conf* as below. The default plugin is *sudoers*.

```bash
[root@ip-172-31-34-111 ~]# grep ^Plugin /etc/sudo.conf
Plugin sudoers_policy sudoers.so
Plugin sudoers_io sudoers.so
```

Once a plugin is enabled, we can adjust its security policies. For example, security polices of plugin *sudoers* is located in file */etc/sudoers* or */etc/sudoers.d*.

Third party developers can distribute their own plugins and security policies to work seamlessly with the *sudo* front end. This post only talks about plugin *sudoers*.

# Installation #

```bash
[root@host ~]# pacman -S sudo
```

List sudoers policy of a user.

```bash
[root@host ~]# sudo -ll -U <user>
```

# Policy Syntax #

Check the [SUDOERS FILE FORMAT](https://unix.stackexchange.com/a/18880) section in the man page of *suoers(5)*.

sudoers policy is prescribed with Extented Backus-Naur Form (EBNF). Do **not** despair if you are unfamiliar with EBNF; it is fairly simple and take the chance to study it. 

An EBNF definition looks like the following.

```
symbol ::= definition | alternate1 | alternate2
```

Special characters `?` (optional, 0 or 1), `*` (zero or more), and `+` (one or more) mean the same thing as regex. Single quotes denote verbatim character string as opposed to a defined symbol (variable) name. The rest part of EBNF of *sudoer* is left to yourself.

The *sudoers* file is composed of two types of entries: *alias* and *user specification*. The advantage of alias is to group multiple items together and assign a meaningful label. There exist four kinds of aliases, namely 'User_Alias', 'Runas_Alias', 'Host_Alias' and 'Cmd_Alias'. When there exist only few accounts and hostnames concerned, alias is optional.

When a user is matched by multiple entries, they are applied in order but only the last match takes effect. Let's forget about EBNF and alias part (not the focus of this post). The following is a sample of user specification. It is divided into two groups by the `=` separator. The left side defines the object while the right side defines the actions.

```
USER HOSTNAME = (RUNAS_USER) COMMANDS
```

1. USER is the primary key, for which this entry is designated.

   It can be a user name (e.g. *jim*, user ID (`#1000`), group name (`%wheel`), group ID (`%#10`) etc.
2. HOSTNAME defines the location where this user specification takes effect. The *sudoers* file can be shared among multiple systems.

   This field can be hostname, IP address, network range etc. Attention please; the loopback interface, namely *locahost* or *127.0.0.1* will be ignored by *sudoers*.
3. '(RUNAS_USER) COMMANDS' refers to the combination of target user and target commands. They comprise an integrated component.
   1. '(RUNAS_USER)' is an optional field. By default, it is assumed to be '(root)'.
   2. COMMANDS specifies what commands can be executed.

Multiple components are separated by comma. Special value 'ALL' matches everything (e.g. any hostnames).

Entry below means on *debain* host, account *jim* can run */bin/ls* as acount *operator*; he can also run */bin/kill* and */usr/bin/apg* as *root*.

```
jim debian = (operator) /bin/ls, (root) /bin/kill, /usr/bin/apg
```
There are also other interesting fields like 'NOPASSWD:', which is left to yourself.

# Configure Policy #

1. To modify sudoers policy, please use *visudo*.
2. Personally, I'd like to put per-user policy file under directory */etc/sudoers.d/*. Usually, we name the file after the user account in question.

   To make the directory loaded, add the `#includedir` directive in */etc/sudoers*. As per the man page, *sudo* will read each policy file in */etc/sudoers.d*, [skipping](https://bugs.centos.org/view.php?id=5017) filenames that contain a dot '.' ro end with tilde '~'.

Below is an example.

```bash
[root@host ~]# visudo -f /etc/sudoers
[root@host ~]# visudo -f /etc/sudoers.d/user
#
gray	localhost	=	(jim) ALL
%wheel	ALL		=	(root) /bin/iptables
```

Once finished editting, use the option `-c` to verify syntax.

```bash
[root@host ~]# visudo -c -f /etc/sudoers
[root@host ~]# visudo -c -f /etc/sudoers.d/user
```

Then check the result:

```bash
[root@host ~]# sudo -ll -U <user>
```

# Run Command #

```bash
# run as root
[user@host ~]$ sudo <command>

# run as spefici user
[userhost ~]$ sudo -u <target-user> <command>
```

If the command to ran is to edit a protected file, [sudoedit](https://superuser.com/q/785187) is preferred than `sudo vim`.
