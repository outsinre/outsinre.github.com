---
layout: post
title: Android-x86
---

>This post describe customzing *android-x86-4.4-r5.iso*. Regarding the installation, please refer to [virtualbox post](/2015/08/21/virtualbox).

# Customization

1. Download [android-x86-4.4-r5.iso](http://www.android-x86.org/).
2. Mount ISO.

   ```bash
   ~ # mount -t loop /path/to/android-x86-4.4-r5.iso /mnt/android-x86
   ```

   Get *system.sfs* which is a Squashfs (compressed read-only for Linux) that containing the Android */system* partition - our customzation target in this post.
3. Mount Squashfs.

   ```bash
   ~ # mount -t squashfs -t loop /path/to/system.sfs /mnt/squashfs
   # Make sure *sys-fs/squashfs-tools* is installed
   ~ # unsquashfs [-ll] -d /mnt/squashfs /mnt/android-x86/system.sfs
   ```

   There exists only one file *system.img* which is the original *ext4* filesystem of Android */system*. That is to say, the author first create Android */system* partition as IMG and then compress it as Squashfs.
4. Mount IMG.

   ```bash
   ~ # mount -t ext4 -o loop,rw /path/to/system.img /mnt/img
   # or
   ~ # mount -t ext4 -o loop,rw /mnt/squashfs/system.img /mnt/img
   ```

   Do customization here. For example, remove LatinIME, SetupWizard etc. etc. Especially for *build.prop*:

   ```
   # change values
   dalvik.vm.heapstartsize=8m
   dalvik.vm.heapgrowthlimit=150m
   dalvik.vm.heapsize=256m
   # disable the first initialization SetupWizard.
   ro.setupwizard.mode=DISABLED
   # append these two lines to end
   dalvik.vm.execution-mode=int:fast
   ro.sf.lcd_density=160
   ```

   Customization finished. Then we should re-pack the ISO file.
5. Do **NOT** unmount.

   Since custiomization finished, intuitively, we should `umount /mnt/img`, which is fine but far from perfect. For example, after direct umounting, the file size (around 1G) of *system.img* does not change although we removed bunch of built-in apks.

   What we should do is to creating a new IMG.
6. New IMG

   >*make_ext4fs* and *simg2img* can be get (or manually compiled) from the 1st reference (链啊啊接: http://pan.baidu.com/s/1dEZjGfJ 密啊啊码: fyd4).

   ```bash
   ~ # cd /mnt
   # creating new IMG from /mnt/img
   ~ # make_ext4fs -l 700M -s -a system system_sparse.img /mnt/img
   # Convert Android sparse images to raw images
   ~ # simg2img system_sparse.img system_raw.img
   ~ # mv system_raw.img system.img; rm system_sparse.img
   ```

   1. 'l': new IMG file size.
   2. 's': sparse mode to compress IMG file.
   3. 'a': mount point at Android.
   4. Check the new image file size, it's exactly 700M.

   >Not sure yet. If we omit 's' argument, then *simg2img* is optionally (as we don't require *sparse* in Android-x86). But remember IMG in Android-x86 ISO is RAW image. If you are handling an Android ROM image, please *simg2img* to remove *sparse* before mounting.

7. New Squashfs

   >We cannot mount Squashfs as *rw*.

   ```bash
   ~# cd /mnt
   ~ # mksquashfs system.img system.sfs
   ```

8. Re-pack ISO

   >We cannot *mount* ISO as *rw*. Though we can use Archive manager to modify ISO contents, *bootable* information gets lost meanwhile, resulting in ISO unbootable.

   We will use *mkisofs* from *app-cdr/cdrtools* to re-pack ISO, before which we must replace the *system.fs*.

   ```bash
   ~ # cd /mnt
   # copy all the ISO files to a new directory
   ~ # cp -aR /mnt/android-x86 cust_android-x86
   ~ # cp system.sfs cust_android-x86/ (optional if you use Archive manager)
   ~ # cd cust_android-x86/
   ~ # mkisofs -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size 4 -boot-info-table -eltorito-alt-boot -input-charset utf-8 -V Android-x86-4.4-r5 -JTrl -o ../cust_android-x86.iso ./
   ```

   Use `-r` instead of `-R`. `-r` means that we want to use Rockridge extensions. The `-R` command line option also achieves this but in a less satisfactory way. `-R` maintains the UID and GID of each file's owner. The same UID and GID will more than likely be meaningless once the files are transported over to another system, so ownership of all files in the ISO image is set to *root:root* if we use `-r` instead of `-R`. Also, `-R` preserves file permissions, including the *write* flags. Having any of the *write* flags set for a file on a read-only media doesn't make much sense, so `-r` resets it in the filesystem image.

   >Currently there is a bug, the *android-x86/isolinux/android-x86.png* does not load. Maybe due to `-input-charset utf-8`.

9. Refs
   1. [must read](http://d846224089.lofter.com/post/1cc5ca4e_b7a25ab)
   2. [Mount | Modify | Edit | Repack | Create UEFI ISO](http://www.tuxfixer.com/mount-modify-edit-repack-create-uefi-iso-including-kickstart-file/)
   3. [How to modify android-x86 asus_laptop imag](https://gist.github.com/jhorstmann/1579903)
   4. [Repackaging a Linux installation DVD using mkisofs](http://bencane.com/2013/06/12/mkisofs-repackaging-a-linux-install-iso/)
   5. [Modify/Edit/Re-pack ISO Files Using Mkisofs In Linux](http://linuxpitstop.com/edit-iso-files-using-mkisofs-in-linux/)

# Tips

>By switching to virtual terminal (F1 - F6), we get *root* shell.

## Shutdown

```bash
# https://sourceforge.net/p/android-x86/kernel/ci/kernel-4.4/tree/kernel/reboot.c
# Alt-F1
~ # reboot -f/p (shutdown)
~ # reboot (reboot)
```

## Reset

```bash
# Alt-F1
~ # rm -R /data
````
