---
layout: post
title: SSH
---

# SSH ABCs

Secure Shell, or SSH, is a cryptographic (encrypted) network *protocol* to allow remote *login* and *other network services* to operate securely over an unsecured network.

In the old ages, *telnet* protocol traffic is plain text subject to interception. Now services on SSH can be encrypted by different ciphers (i.e. RSA, DSA etc.). In addition to *remote login*, other services can reside on SSH protocol like content transmission.

*protocol* (i.e. SSH) is different from *application* or *command* (i.e. ssh, scp etc.). On Linux system, the application that implements SSH protocol is called OpenSSH. OpenSSH gives commands like ssh, scp, sftp, ssh-keygen etc.

# Goal

In this post, I will setup remote login with Public-key infrastructure to achieve passwordless connection.

1. local host
2. remote host
3. ssh from local host to remote host

    Without remote user password and local public-key pair passphrase.

# Generate Public-key pair

The core of Public-key infrastructure is create personal public and private key pair. The public key as denoted is distributed *publicly* over the Internet, while the private key is *privately* kept by ourself.

On local host that we connect from, run `ssh-keygen`:

```
~ $ ssh-keygen -t rsa -C "rsa-keys"
Generating public/private rsa key pair.
Enter file in which to save the key (/home/username/.ssh/id_rsa): 
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/username/.ssh/id_rsa.
Your public key has been saved in /home/username/.ssh/id_rsa.pub.
The key fingerprint is:
SHA256:abcdedajfajqiefafanfaqrnafafaf8rqhfafdafjajfafeaqn rsa-keys
The key's randomart image is:
+---[RSA 2048]----+
|        .+o+o.+==|
|       oE.o..q..=|
|      . o=o......|
|     + o.=o..s. .|
|    . + S . .... |
|     . + . ..q.  |
|    . . +    .   |
|   o ..+     w   |
|  .o==+ +        |
+----[SHA256]-----+
```

1. ***Don't use ssh-dss (DSA) public key algorithm***!!! Refer to [openssh legacy](http://www.openssh.com/legacy.html). The default algorithm is *rsa*.
1. *~/.ssh/id_rsa* is the private key (also termed as *identity* in SSH); *~/.ssh/id_rsa.pub* is the public key to be shared over the Internet.
2. It prompts for *passphrase* to encrypt public-key files *locally*. If someone steal the private key file, he cannot impersonate you to communicate on the Internet. You are encouraged to set a passphrase.

    You can just press ENTER key to not use passphrase - empty passphrase. This do make a difference when connecting to remote host. Details refer below.

# Distribute the public key

Now share the public key file *~/.ssh/id_rsa.pub* over the Internet to remote host. *append* the key file to *~/.ssh/authorized_keys* on remote host.

*authorized_keys* is a file that stores SSH public keys. Each time a new publick-key pair is generated, append the new public key to it. To accomplish this, run `ssh-copy-id`:

```
ssh-copy-id -i ~/.ssh/id_rsa.pub -p 22 uname@192.168.0.10
```

Alternatively, we can use:

```
cat ~/.ssh/id_rsa.pub | ssh -p 22 uname@192.168.0.10 "mkdir -p ~/.ssh && cat >>  ~/.ssh/authorized_keys"
```

1. *remotre-domain-name* can be the IP or domain name of remote host.
2. Both ways achieve the same purpose: append the public key to *authorized_keys* file. `ssh-copy-id` automatically creates *~/.ssh/authorized_keys* if it does not exist.
3. Pay attention to `-p` argument of `mkdir`: make parent directories as needed, no error if existing.

No matter which command you chose, you should see something like:

```
The authenticity of host '[192.168.0.10]:22 ([192.168.0.10]:22)' can't be established.
RSA key fingerprint is SHA256:afjaijfjfajeiqrityqpqvnbvlaeafjadfj.
Are you sure you want to continue connecting (yes/no)? yes
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
uname@192.168.0.10's password: 

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh -p '22' 'uname@192.168.0.10'"
and check to make sure that only the key(s) you wanted were added.
```

1. SSH with Public-key has not been configured yet. So you are required to provide the remote host *username* password.
2. SSH into remote host to make sure *authorized_keys* permission is *600*.

# SSH

Now you can connect to remote host by Public-key.

```
ssh -p 22 uname@192.168.0.10
Enter passphrase for key '/home/username/.ssh/id_rsa': 
Last login: Thu Dec  3 07:59:14 2015 from 122.205.7.55
```

By default, both public-key and username password are enabled to accept remote login. What's more, public-key way is superior to username password.

From the output, `ssh` prompts you to input *passphrase* of public-key files. Recall that we have set a passphrase when generating public-key pair to encrypt public-key files on local host.

*if you leave the passphrase empty*, `ssh` will login immediately without any interaction - *passwordless* login. However, such login lose security of public-key files themselves.

# Passwordless

A better way on local host is to:

1. Use passphrase to encrypt public-key files.
2. Use *ssh-agent* and *ssh-add* to unlock public-key files automatically.

The little program *ssh-agent* does you a favor by managing your keys for you. You enter the passphrase once, and after that, *ssh-agent* keeps your key cached in its memory and pulls it up whenever it is asked for it. 

To use the agent first start it. Just enter `eval "$(ssh-agent -s)"` and thats all. This will put you in a bash shell which is spawned by *ssh-agent*.

After that you should add your key (file). To do this enter the command `ssh-add`. This will try and add the standard key *identity* to the key manager. To add a key with a different name/location, enter "ssh-add /location/of/key".

*ssh-add* program will ask you for your *passphrase*. After that the key is loaded into the key manager *ssh-agent*. 

1. Make sure `ssh-agent` is running: `ps -ef | grep -i ssh-agent`.

    `printenv | grep -i ssh`, you will find two important environment variables `SSH_AGENT_PID` (agent process ID) and `SSH_AUTH_SOCK` (agent socket location on system) exported by current *ssh-agent*.

    *ssh-agent* is usually started at the beginning of the X session, or from a shell startup script like "~/.bash_profile". It works by creating a unix-socket, and registering the appropriate environment variables so that all subsequent applications can take advantage of its services by connecting to that socket. Clearly, it only makes sense to start it in the parent process of an X session to use the set of decrypted private keys in all subsequent X applications.

    On my Gentoo system, 'startx' will help launch *ssh-agent* automatically. If not, add ``eval `ssh-agent -s` > /dev/null`` to *.xinitrc/.bash_profile* (for the whole X session) or *.bashrc* (only for interactive shell).

    Use `eval "$(ssh-agent -s)"` or ``eval `ssh-agent -s``` . **DO NOT USE `ssh-agent -s` directly which DOES NOT EXPORT the two variables for you**. This rule also applies to `ssh-agent -k` etc. commands.
2. Current agent

    There may be multiple agents running at system. The current agent means the agent that exports `SSH_AGENT_PID` and `SSH_AUTH_SOCK`. To switch to another agent, just set the two variables to the agent's process ID and socket location.

    Details refer to *ssh-find-agent* below.
3. Add key file to agent.

    ```
    ssh-add ~/.ssh/id_rsa
    Enter passphrase for /home/username/.ssh/id_rsa: 
    Identity added: /home/username/.ssh/id_rsa (/home/username/.ssh/id_rsa)
    ```
    Type your passhrase. Now, you should NOT be prompted for a password whenever you use ssh, scp, or sftp etc. commands.

    You can omit the *~/.ssh/id_rsa* argument. When run without arguments, it adds the files *~/.ssh/id_rsa*, *~/.ssh/id_dsa*, *~/.ssh/id_ecdsa*, *~/.ssh/id_ed25519* and *~/.ssh/identity* (SSHv1).
4. Limit: *ssh-add* does NOT persist across *ssh-agent* sessions, which happens when reboot/shutdown/logout. So usuallly the *passwordless* login only lasts for the current session.

    Each time of login and SSH connection, run `ssh-add` once to achieve passwordless login. For a server, this is fine. But on personal laptop/PC that require shutdown frequently, it is tedious/annoying to run `ssh-add`.

    This is a trade-off between security and utility.
5. What we have gone through is X session and terminal emulators. But how about virtual terminal/console?

    For example, on my Gentoo, *ssh-agent* started with `startx` XFCE4 DE is attached that specific X session (Xfce4-terminal emulator included). If I don't launch `startx` or switch to another virtual terminal (Ctrl+Alt+F2) and login, this login shell does not either start *ssh-agent* or know the agent already launched!

    You can launch *ssh-agent* in shell's configuration script (*.bashrc*, *.bash_profile* etc.). *.bashrc* is mostly for *interactive shell in X environment* while *.bash_profile* is for *login shell*. At the end of *.bash_profile*, *.bashrc* is sourced. If you want to execute a shell script *only once* for the whole login, add to *.bash_profile* instead of *.bashrc* (would be executed each time a new terminal emulator launched).


    However, this is not a good way as it launch agent on every login. We only need SSH on demand! So the basic idea is to:

    1. let new login shell reuse eixsting ssh-agent instance.
    2. If there is not any agents, create one.

## ssh-find-agent

[ssh-find-agent](https://github.com/wwalker/ssh-find-agent) is a tool for locating *existing* ssh compatible agent processes (e.g., ssh-agent, gpg-agent, gnome-keyring, osx-keychain); and, optionally, setting `SSH_AUTH_SOCK` accordingly.

1. Download (or git clone) the script *ssh-find-agent.sh* somewhere. Make sure it's executable.
2. Add `source /path/to/ssh-find-agent.sh` to *.bashrc*.

    If added to *.bash_profile*, terminal emulator under X could not find *ssh-find-agent* command.
3. List existing agents.

    ```bash
    ~ $ ssh-find-agent
    ```
    Without any arguments.

    If there does not exist any agents, prompt to create one.
    
    If there exist agents but no keys/identities added, create temporal alias for *ssh* command, which guarantee the very first execution of *ssh* prompots for public-key passphrase to add keys. Details refer below.
3. Two ways to reuse existing ssh-agents:
    1. Manually.

        ```bash
        ~ $ ssh-find-agent -c # or --choose, to choose one of existing agents
        ```
    2. Automatically.

        ```bash
        ~ $ ssh-find-agent -a # or --auto, to choose an agent automatically
        ```
4. ssh-find-aggent prompt to launch ssh-agent if there is not any one.

    ```bash
    if [ -z "$_LIVE_AGENT_LIST" ]
    then
	    echo "No agents found"
	    read -p "Create an agent and add keys (y/n)?" -n 1 -r
	    echo # (optional) move to a new line
	    if [[ $REPLY =~ ^[Yy]$ ]]
	    then
		    if [ -z "$SSH_AUTH_SOCK" ]
		    then
			    eval "$(ssh-agent -s)" > /dev/null
			    ssh-add -l > /dev/null || alias ssh='ssh-add -l >/dev/null || ssh-add && unalias ssh; ssh'
		    fi
	    elif  [[ ! $REPLY =~ ^[Yy]$ ]]; then
		    :
	    fi
    else
	    ssh-add -l > /dev/null || alias ssh='ssh-add -l >/dev/null || ssh-add && unalias ssh; ssh'
    fi
    ```
    Insert the codes to the end of function `find_all_agent_sockets()` in *ssh-find-agent.sh*.

    `alias ssh='ssh-add -l >/dev/null || ssh-add && unalias ssh; ssh'` will temporarily set alias for *ssh*. When you connect with *ssh* at the very beginniing, it will add keys to agent first. Use `type ssh` to test *ssh* alias.
5. For the most updates, refer to my GitHub repository.

# Make it simple

1. By ssh-find-agent:
    1. ssh-find-agent
    2. ssh
2. What we have:
    1. eval `ssh-agent -s`
    2. ssh-add
    3. ssh

# SSH config

ssh_config

sshd_config

disable password auth (keep key files, don't lose)

add a script for ssh

# Reference

1. [使用密钥登录并禁止口令登录实践](http://wsgzao.github.io/post/ssh/)
2. [setup SSH with DSA public key authentication (password less login)](http://www.cyberciti.biz/faq/ssh-password-less-login-with-dsa-publickey-authentication/)
3. [Using ssh-agent with ssh](http://mah.everybody.org/docs/ssh)
4. [ssh无密码登入设置](http://www.jiangmiao.org/blog/559.html)
5. [How To Set Up SSH Keys](https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys--2)
6. [how to ssh without a password](http://www.gentoo-wiki.info/HOWTO_SSH_without_a_password).
7. [Understanding ssh-agent and ssh-add](http://blog.joncairns.com/2013/12/understanding-ssh-agent-and-ssh-add/)
8. [ssh-find-agent](https://github.com/wwalker/ssh-find-agent)
